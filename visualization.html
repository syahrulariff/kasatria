<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Visualization — Private Sheets (Apps Script)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;background:#111;color:#fff;font-family:Arial,Helvetica,sans-serif}
    #container{position:relative;height:100vh;overflow:hidden}
    .element{
      width: 160px; height: 200px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      padding:8px; box-sizing:border-box; cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
      font-size:13px;
      color:#000;
    }
    .element img { width:80px; height:80px; object-fit:cover; border-radius:50%; margin-bottom:8px; }
    .controls { position:absolute; left:10px; top:10px; z-index:20; display:flex; gap:8px; }
    .controls button { background:#222;border:0;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer }
    .note { position:absolute; left:10px; bottom:10px; z-index:20; background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:8px; font-size:12px}
    #loading { position:absolute; right:10px; top:10px; z-index: 30; background: rgba(0,0,0,0.6); padding:8px 12px; border-radius:8px }
  </style>
</head>
<body>
  <div id="container"></div>

  <div class="controls">
    <button id="btnTable">TABLE (20x10)</button>
    <button id="btnSphere">SPHERE</button>
    <button id="btnHelix">DOUBLE HELIX</button>
    <button id="btnGrid">GRID</button>
  </div>

  <div id="loading">Loading data…</div>
  <div class="note">Tiles colored by Net Worth: Red &lt;$100K, Orange &lt;$200K, Green ≥$200K</div>

  <!-- Compatible Three.js + CSS3DRenderer -->
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r148/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r148/examples/js/renderers/CSS3DRenderer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

  <script>
  // ========== CONFIG ===========
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby970p916NRoXKtxI_RaYbGWwoF21EwkgdsC_TsTo9ekgc6Ch82A0IfKc4WtxRl9r7D/exec"; // <-- paste your web app URL here
  // ============================

  const container = document.getElementById('container');
  const loadingEl = document.getElementById('loading');

  let camera, scene, renderer;
  const objects = [];
  const targets = { table: [], sphere: [], helix: [], grid: [] };

  // Init + animate
  init();
  animate();

  async function init() {
    camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 10000);
    camera.position.z = 3400;

    scene = new THREE.Scene();

    // Attempt to fetch JSON from Apps Script
    try {
      loadingEl.textContent = 'Fetching sheet data…';
      const resp = await fetch(APPS_SCRIPT_URL, { method: 'GET' });
      if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
      const json = await resp.json();
      if (json.error) throw new Error(json.error);
      const rows = json.data; // array of objects, keys = headers

      if (!rows || rows.length === 0) {
        throw new Error('No rows returned from Apps Script');
      }

      // Build CSS3D elements
      rows.forEach((row, i) => {
        // normalize access: headers might include spaces etc.
        const name = row['Name'] || row['name'] || '';
        const photo = row['Photo'] || row['photo'] || '';
        const age = row['Age'] || row['age'] || '';
        const country = row['Country'] || row['country'] || '';
        const interest = row['Interest'] || row['interest'] || '';
        const netRaw = row['Net Worth'] || row['NetWorth'] || row['Net_Worth'] || row[' Net Worth'] || '';
        const netNum = row['NetWorthNumber'] !== undefined ? row['NetWorthNumber'] : ( (netRaw+'').toString().replace(/[^0-9.-]+/g,'') || 0 );

        // Create card
        const el = document.createElement('div');
        el.className = 'element';
        el.style.background = netColor(Number(netNum));
        el.style.color = '#000';

        el.innerHTML = `
          <img src="${escapeHtml(photo)}" alt="${escapeHtml(name)}" onerror="this.style.display='none'">
          <div style="font-weight:700; text-align:center; margin-bottom:4px">${escapeHtml(name)}</div>
          <div style="font-size:12px; text-align:center; opacity:.9">${escapeHtml(age)} yrs • ${escapeHtml(country)}</div>
          <div style="font-size:12px; text-align:center; margin-top:6px">${escapeHtml(interest)}</div>
          <div style="font-weight:700; margin-top:8px; text-align:center">${formatMoney(netNum)}</div>
        `;

        const obj = new THREE.CSS3DObject(el);
        obj.position.x = Math.random()*4000 - 2000;
        obj.position.y = Math.random()*4000 - 2000;
        obj.position.z = Math.random()*4000 - 2000;
        scene.add(obj);
        objects.push(obj);

        // table target: 20 x 10 arrangement
        const tableTarget = new THREE.Object3D();
        const col = i % 20;
        const rowIndex = Math.floor(i / 20);
        tableTarget.position.x = (col * 180) - ( (20 * 180) / 2 ) + 90;
        tableTarget.position.y = - (rowIndex * 220) + ( (10 * 220) / 2 ) - 110;
        targets.table.push(tableTarget);
      });

      // Sphere targets
      const vector = new THREE.Vector3();
      const spherical = new THREE.Spherical();
      const l = objects.length;
      for (let i = 0; i < l; i++) {
        const phi = Math.acos(-1 + (2 * i) / l);
        const theta = Math.sqrt(l * Math.PI) * phi;
        const obj = new THREE.Object3D();
        spherical.set(900, phi, theta);
        obj.position.setFromSpherical(spherical);
        vector.copy(obj.position).multiplyScalar(2);
        obj.lookAt(vector);
        targets.sphere.push(obj);
      }

      // Double helix targets (interleaved)
      createDoubleHelixTargets(objects.length);

      // Grid 5x4x10 (x,y,z)
      for (let i=0; i<objects.length; i++){
        const g = new THREE.Object3D();
        const gx = i % 5;
        const gy = Math.floor((i / 5) % 4);
        const gz = Math.floor(i / (5*4));
        g.position.x = (gx * 420) - ( (5*420)/2 ) + 210;
        g.position.y = - (gy * 420) + ( (4*420)/2 ) - 210;
        g.position.z = (gz * 420) - ( (10*420)/2 ) + 210;
        targets.grid.push(g);
      }

      // renderer
      renderer = new THREE.CSS3DRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      // hook buttons
      document.getElementById('btnTable').onclick = () => transform(targets.table, 1500);
      document.getElementById('btnSphere').onclick = () => transform(targets.sphere, 1500);
      document.getElementById('btnHelix').onclick = () => transform(targets.helix, 1500);
      document.getElementById('btnGrid').onclick = () => transform(targets.grid, 1500);

      // initial transform
      transform(targets.table, 1500);
      loadingEl.style.display = 'none';

    } catch (err) {
      loadingEl.textContent = 'Error: ' + err.message;
      console.error(err);
    }

    window.addEventListener('resize', onWindowResize);
  }

  function createDoubleHelixTargets(total){
    targets.helix.length = 0;
    const radius = 700;
    const separation = 140;
    const pitch = 12;
    let aIndex = 0, bIndex = 0;
    for (let i=0;i<total;i++){
      const strand = (i % 2 === 0) ? 0 : 1;
      const idx = strand === 0 ? aIndex++ : bIndex++;
      const theta = idx * 0.45;
      const y = -(idx * pitch) + ( (Math.ceil(total/2) * pitch) / 2 );
      const obj = new THREE.Object3D();
      const offset = (strand === 0) ? separation/2 : -separation/2;
      obj.position.x = Math.cos(theta) * radius + offset;
      obj.position.z = Math.sin(theta) * radius;
      obj.position.y = y;
      obj.lookAt(new THREE.Vector3(0,y,0));
      targets.helix.push(obj);
    }
  }

  function transform(targetsArray, duration) {
    TWEEN.removeAll();
    for (let i = 0; i < objects.length; i++) {
      const object = objects[i];
      const target = targetsArray[i];
      if (!target) continue;
      new TWEEN.Tween(object.position)
        .to({ x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration)
        .easing(TWEEN.Easing.Exponential.InOut)
        .start();
      new TWEEN.Tween(object.rotation)
        .to({ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration)
        .easing(TWEEN.Easing.Exponential.InOut)
        .start();
    }
    new TWEEN.Tween(this).to({}, duration * 2).onUpdate(render).start();
  }

  function onWindowResize(){
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate(){
    requestAnimationFrame(animate);
    TWEEN.update();
    renderer.render(scene, camera);
  }

  function netColor(n){
    if (Number(n) < 100000) return '#ff7b7b';
    if (Number(n) < 200000) return '#ffb86b';
    return '#9cff8e';
  }
  function formatMoney(n){
    n = Number(n) || 0;
    return '$' + n.toLocaleString();
  }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  </script>
</body>
</html>

