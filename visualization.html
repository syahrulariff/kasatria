<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Data Periodic Table — Demo (Adjusted Columns)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:#111; color:#fff; }
    #container { position:relative; width:100%; height:100vh; overflow:hidden; }
    .element {
      width: 140px; height: 180px;
      box-shadow: 0 8px 20px rgba(0,0,0,.6);
      border-radius: 10px;
      text-align:center;
      padding:8px;
      box-sizing:border-box;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:6px;
    }
    .element img { width:100%; height:70px; object-fit:cover; border-radius:8px; }
    .element .name { font-size:14px; font-weight:700; }
    .element .meta { font-size:12px; opacity:.9; }
    .controls { position:absolute; left:10px; top:10px; z-index:10; }
    .controls button { margin-right:6px; padding:8px 12px; border-radius:6px; border:none; background:#222; color:#fff; cursor:pointer; }
    #signin { position:absolute; right:10px; top:10px; z-index:10; }
  </style>
</head>
<body>
  <div id="container"></div>
  <div class="controls" id="controls">
    <button id="table">TABLE</button>
    <button id="sphere">SPHERE</button>
    <button id="helix">HELIX (Double)</button>
    <button id="grid">GRID</button>
  </div>
  <div id="signin"></div>

  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/renderers/CSS3DRenderer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

  <script>
  /*********************** CONFIG *************************/
  // Paste your published CSV URL here (File -> Publish to web OR use export?format=csv)
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQAOEljj3qH1g7oZoxAjANRZ8u_9DyX2NjhGktnJEJssNNV_ymwQVyaGCUVn3AOz4pFX34U7bJyMUV/pub?gid=722838119&single=true&output=csv";
  const USE_SHEETS_API = false; // keep false for public CSV
  /********************************************************/

  let camera, scene, renderer;
  const objects = [];
  const targets = { table:[], sphere:[], helix:[], grid:[] };

  init();
  animate();

  function init(){
    const container = document.getElementById('container');

    camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
    camera.position.z = 3000;

    scene = new THREE.Scene();

    renderer = new THREE.CSS3DRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.position = 'absolute';
    container.appendChild(renderer.domElement);

    document.getElementById('table').addEventListener('click', () => transform(targets.table, 2000));
    document.getElementById('sphere').addEventListener('click', () => transform(targets.sphere, 2000));
    document.getElementById('helix').addEventListener('click', () => transform(targets.helix, 2000));
    document.getElementById('grid').addEventListener('click', () => transform(targets.grid, 2000));

    if (SHEET_CSV_URL && SHEET_CSV_URL !== "REPLACE_WITH_PUBLISHED_CSV_URL") {
      loadFromCsv(SHEET_CSV_URL);
    } else {
      const el = document.createElement('div');
      el.style.position='absolute'; el.style.left='10px'; el.style.bottom='10px'; el.style.zIndex=20;
      el.innerHTML = '<div style="background:#222;padding:10px;border-radius:6px;">Paste your published CSV URL in the script (SHEET_CSV_URL) and reload.</div>';
      document.body.appendChild(el);
    }

    window.addEventListener('resize', onWindowResize, false);
  }

  function onWindowResize(){
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  async function loadFromCsv(url){
    try {
      const res = await fetch(url);
      const text = await res.text();
      const rows = csvToArray(text);
      const headers = rows.shift().map(h=>h.trim());
      const items = rows.map(r => mapRowToItem(headers, r));
      buildObjects(items);
    } catch(err){
      console.error(err);
      alert("Error loading CSV. Ensure the sheet is published to web and URL is correct.");
    }
  }

  function csvToArray(str){
    const lines = str.trim().split(/\r?\n/).map(l=>l);
    return lines.map(line => {
      const out=[]; let cur='', inQuotes=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch === '"' ){ inQuotes = !inQuotes; continue; }
        if (ch === ',' && !inQuotes){ out.push(cur); cur=''; continue; }
        cur += ch;
      }
      out.push(cur);
      return out;
    });
  }

  function mapRowToItem(headers, row){
    const obj = {};
    for (let i=0;i<headers.length;i++){
      obj[ headers[i] ] = row[i] ? row[i].trim() : "";
    }
    // Normalize expected columns (case-insensitive keys fallback)
    obj.Name = obj['Name'] || obj['name'] || "";
    obj.Photo = obj['Photo'] || obj['photo'] || "";
    obj.Age = obj['Age'] || obj['age'] || "";
    obj.Country = obj['Country'] || obj['country'] || "";
    obj.Interest = obj['Interest'] || obj['interest'] || "";
    const rawNW = obj['Net Worth'] || obj['NetWorth'] || obj['net worth'] || obj['NetWorth'] || "";
    obj._netWorth = parseFloat((rawNW + "").replace(/[^0-9.-]+/g,"")) || 0;
    return obj;
  }

  function buildObjects(items){
    // reset
    while(scene.children.length) scene.remove(scene.children[0]);
    objects.length = 0;
    targets.table.length = targets.sphere.length = targets.helix.length = targets.grid.length = 0;

    items.forEach((item, i) => {
      const element = document.createElement('div');
      element.className = 'element';
      const color = networthColor(item._netWorth);
      element.style.background = color;
      element.style.color = '#000';

      // photo if any
      if (item.Photo) {
        const img = document.createElement('img');
        img.src = item.Photo;
        img.alt = item.Name || '';
        element.appendChild(img);
      }

      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.textContent = item.Name || `Row ${i+1}`;
      element.appendChild(nameEl);

      const meta1 = document.createElement('div');
      meta1.className = 'meta';
      meta1.textContent = `Age: ${item.Age || '-'} • ${item.Country || '-'}`;
      element.appendChild(meta1);

      const meta2 = document.createElement('div');
      meta2.className = 'meta';
      meta2.textContent = item.Interest || '-';
      element.appendChild(meta2);

      const netEl = document.createElement('div');
      netEl.style.marginTop='6px';
      netEl.style.fontWeight='700';
      netEl.textContent = formatMoney(item._netWorth);
      element.appendChild(netEl);

      const cssObject = new THREE.CSS3DObject(element);
      cssObject.position.x = Math.random() * 4000 - 2000;
      cssObject.position.y = Math.random() * 4000 - 2000;
      cssObject.position.z = Math.random() * 4000 - 2000;
      scene.add(cssObject);
      objects.push(cssObject);

      // Table (20x10)
      const tableObj = new THREE.Object3D();
      const col = i % 20;
      const row = Math.floor(i / 20);
      tableObj.position.x = (col * 160) - ( (20 * 160) / 2 ) + 80;
      tableObj.position.y = - (row * 200) + ( (10 * 200) / 2 ) - 100;
      targets.table.push(tableObj);

      // Sphere
      const vector = new THREE.Vector3();
      const spherical = new THREE.Spherical();
      spherical.radius = 900;
      spherical.phi = Math.acos( -1 + ( 2 * i ) / items.length );
      spherical.theta = Math.sqrt(items.length * Math.PI) * spherical.phi;
      vector.setFromSpherical(spherical);
      const sphereObj = new THREE.Object3D();
      sphereObj.position.copy(vector);
      sphereObj.lookAt(new THREE.Vector3(0,0,0));
      targets.sphere.push(sphereObj);

      // Helix placeholder (will be replaced by double helix generator)
      const helixObj = new THREE.Object3D();
      const theta = i * 0.35;
      const helixRadius = 700;
      const helixY = - (i * 10) + 600;
      helixObj.position.x = Math.cos(theta) * helixRadius;
      helixObj.position.y = helixY;
      helixObj.position.z = Math.sin(theta) * helixRadius;
      helixObj.lookAt(new THREE.Vector3(0, helixY, 0));
      targets.helix.push(helixObj);

      // Grid 5x4x10
      const gridObj = new THREE.Object3D();
      const gridX = i % 5;
      const gridY = Math.floor((i / 5) % 4);
      const gridZ = Math.floor(i / (5*4));
      gridObj.position.x = (gridX * 450) - ( (5*450)/2 ) + 225;
      gridObj.position.y = - (gridY * 450) + ( (4*450)/2 ) - 225;
      gridObj.position.z = (gridZ * 450) - ( (10*450)/2 ) + 225;
      targets.grid.push(gridObj);
    });

    // replace helix targets with double helix
    createDoubleHelixTargets(items.length);

    // start in table view
    transform(targets.table, 2000);
  }

  function createDoubleHelixTargets(total){
    targets.helix.length = 0;
    const radius = 700;
    const separation = 150;
    for (let i=0;i<total;i++){
      const strand = i % 2 === 0 ? 0 : 1;
      const indexInStrand = Math.floor(i/2);
      const theta = indexInStrand * 0.45;
      const y = -(indexInStrand * 14) + (total/2 * 7) - 120;
      const obj = new THREE.Object3D();
      const offset = (strand === 0) ? separation/2 : -separation/2;
      obj.position.x = Math.cos(theta) * radius + offset;
      obj.position.z = Math.sin(theta) * radius;
      obj.position.y = y;
      obj.lookAt(new THREE.Vector3(0, y, 0));
      targets.helix.push(obj);
    }
  }

  function transform(targetArr, duration){
    TWEEN.removeAll();
    for (let i=0;i<objects.length;i++){
      const object = objects[i];
      const target = targetArr[i];
      if (!target) continue;
      new TWEEN.Tween(object.position)
        .to({ x: target.position.x, y: target.position.y, z: target.position.z }, Math.random()*duration + duration)
        .easing(TWEEN.Easing.Exponential.InOut)
        .start();
      new TWEEN.Tween(object.rotation)
        .to({ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random()*duration + duration)
        .easing(TWEEN.Easing.Exponential.InOut)
        .start();
    }
    new TWEEN.Tween(this).to({}, duration*2).onUpdate(render).start();
  }

  function animate(){
    requestAnimationFrame(animate);
    TWEEN.update();
    render();
  }

  function render(){
    renderer.render(scene, camera);
  }

  function networthColor(n){
    if (n < 100000) return "#ff7b7b"; // red
    if (n < 200000) return "#ffb86b"; // orange
    return "#9cff8e"; // green
  }

  function formatMoney(n){
    if (!n) return "$0";
    return "$" + n.toLocaleString();
  }
  </script>
</body>
</html>

