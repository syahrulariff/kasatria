<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>3D Visualization from Google Sheet</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #111;
        margin: 0;
        overflow: hidden;
        color: white;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        background: #222;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      button:hover {
        background: #444;
      }
      .note {
        position: absolute;
        bottom: 10px;
        left: 10px;
        font-size: 13px;
        color: #ccc;
      }
    </style>
  </head>
  <body>
    <div id="menu">
      <button id="table">TABLE (20x10)</button>
      <button id="sphere">SPHERE</button>
      <button id="helix">DOUBLE HELIX</button>
      <button id="grid">GRID (5x4x10)</button>
    </div>
    <div id="container"></div>
    <div class="note">
      Tiles colored by Net Worth: Red &lt;$100K, Orange &lt;$200K, Green ≥$200K
    </div>

    <!-- ✅ Compatible Three.js + CSS3DRenderer -->
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r148/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r148/examples/js/renderers/CSS3DRenderer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

    <script>
      const container = document.getElementById('container');
      let camera, scene, renderer;
      let objects = [];
      let targets = { table: [], sphere: [], helix: [], grid: [] };

      // ✅ Initialize Scene
      init();
      animate();

      async function init() {
        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.z = 3000;

        scene = new THREE.Scene();

        // ✅ Load Google Sheet Data (CSV from your URL)
        const sheetURL =
          'https://docs.google.com/spreadsheets/d/e/2PACX-1vRQAOEljj3qH1g7oZoxAjANRZ8u_9DyX2NjhGktnJEJssNNV_ymwQVyaGCUVn3AOz4pFX34U7bJyMUV/pub?gid=722838119&single=true&output=csv';

        const response = await fetch(sheetURL);
        const csvText = await response.text();
        const rows = csvText.split('\n').slice(1); // skip header

        rows.forEach((row, i) => {
          const cols = row.split(',');
          if (cols.length < 6) return;

          const [name, photo, age, country, interest, networthStr] = cols;
          const netWorth = parseFloat(networthStr.replace(/[^0-9.]/g, '')) || 0;

          const element = document.createElement('div');
          element.className = 'element';
          element.style.width = '160px';
          element.style.height = '220px';
          element.style.borderRadius = '10px';
          element.style.boxShadow = '0 0 15px rgba(255,255,255,0.1)';
          element.style.padding = '8px';
          element.style.backgroundColor =
            netWorth < 100000
              ? 'rgba(255, 0, 0, 0.8)'
              : netWorth < 200000
              ? 'rgba(255, 165, 0, 0.8)'
              : 'rgba(0, 255, 0, 0.8)';

          element.innerHTML = `
            <div style="text-align:center">
              <img src="${photo}" width="80" height="80" style="border-radius:50%;object-fit:cover;margin-top:5px;">
              <h3>${name}</h3>
              <p>${age} yrs | ${country}</p>
              <p>${interest}</p>
              <p><b>${networthStr}</b></p>
            </div>
          `;

          const objectCSS = new THREE.CSS3DObject(element);
          objectCSS.position.x = Math.random() * 4000 - 2000;
          objectCSS.position.y = Math.random() * 4000 - 2000;
          objectCSS.position.z = Math.random() * 4000 - 2000;
          scene.add(objectCSS);
          objects.push(objectCSS);

          // Table layout (20x10)
          const object = new THREE.Object3D();
          object.position.x = (i % 20) * 200 - 1800;
          object.position.y = -(Math.floor(i / 20) % 10) * 200 + 800;
          targets.table.push(object);
        });

        // ✅ Sphere layout
        const vector = new THREE.Vector3();
        const spherical = new THREE.Spherical();
        for (let i = 0, l = objects.length; i < l; i++) {
          const phi = Math.acos(-1 + (2 * i) / l);
          const theta = Math.sqrt(l * Math.PI) * phi;
          const object = new THREE.Object3D();
          spherical.set(800, phi, theta);
          object.position.setFromSpherical(spherical);
          vector.copy(object.position).multiplyScalar(2);
          object.lookAt(vector);
          targets.sphere.push(object);
        }

        // ✅ Double Helix layout
        for (let i = 0, l = objects.length; i < l; i++) {
          const theta = i * 0.175 + Math.PI;
          const y = -(i * 8) + 450;
          const object = new THREE.Object3D();
          object.position.set(900 * Math.sin(theta), y, 900 * Math.cos(theta));
          const object2 = object.clone();
          object2.position.x *= -1;
          targets.helix.push(object);
          targets.helix.push(object2);
        }

        // ✅ Grid layout 5x4x10
        for (let i = 0; i < objects.length; i++) {
          const object = new THREE.Object3D();
          object.position.x = (i % 5) * 400 - 800;
          object.position.y = -(Math.floor((i / 5) % 4) * 400) + 400;
          object.position.z = Math.floor(i / 20) * 1000 - 2000;
          targets.grid.push(object);
        }

        // ✅ Renderer
        renderer = new THREE.CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // ✅ Button events
        document.getElementById('table').addEventListener('click', () => transform(targets.table, 2000));
        document.getElementById('sphere').addEventListener('click', () => transform(targets.sphere, 2000));
        document.getElementById('helix').addEventListener('click', () => transform(targets.helix, 2000));
        document.getElementById('grid').addEventListener('click', () => transform(targets.grid, 2000));

        transform(targets.table, 2000);
        window.addEventListener('resize', onWindowResize);
      }

      // ✅ Transform animation
      function transform(targets, duration) {
        gsap.killTweensOf(objects);
        for (let i = 0; i < objects.length; i++) {
          gsap.to(objects[i].position, {
            duration: duration / 1000,
            x: targets[i].position.x,
            y: targets[i].position.y,
            z: targets[i].position.z,
            ease: 'power2.inOut',
          });
          gsap.to(objects[i].rotation, {
            duration: duration / 1000,
            x: targets[i].rotation.x,
            y: targets[i].rotation.y,
            z: targets[i].rotation.z,
            ease: 'power2.inOut',
          });
        }
      }

      // ✅ Resize handler
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      // ✅ Animation loop
      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
